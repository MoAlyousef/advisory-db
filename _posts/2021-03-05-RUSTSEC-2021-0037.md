---
title:       "RUSTSEC-2021-0037: diesel: Fix a use-after-free bug in diesels Sqlite backend"
description: "Weve misused sqlite3columnname. The SQLitehttpswww.sqlite.orgc3refcolumnname.html documentation states that the following  The returned string pointer is valid until either the prepared statement  is destroyed by sqlite3finalize or until the statement is automatically  reprepared by the first call to sqlite3step for a particular  run or until the next call to sqlite3columnname  or sqlite3columnname16 on the same column. As part of our querybyname infrastructure weve first received all field names for the prepared statement and stored them as string slices for later use. After that we called sqlite3step for the first time, which invalids the pointer and therefore the stored string slice."
date:        2021-03-05
tags:        diesel use after free
permalink:   /advisories/RUSTSEC-2021-0037:output_ext
---

### Description

We've misused `sqlite3_column_name`. The
[SQLite](https://www.sqlite.org/c3ref/column_name.html) documentation
states that the following:

> The returned string pointer is valid until either the prepared statement
> is destroyed by sqlite3_finalize() or until the statement is automatically
> reprepared by the first call to sqlite3_step() for a particular
> run or until the next call to sqlite3_column_name()
> or sqlite3_column_name16() on the same column.

As part of our `query_by_name` infrastructure we've first received all
field names for the prepared statement and stored them as string slices
for later use. After that we called `sqlite3_step()` for the first time,
which invalids the pointer and therefore the stored string slice.

### More Info

<https://github.com/diesel-rs/diesel/pull/2663>

### Patched Versions

- `>=1.4.6`


